{% extends "base.html" %}

{% block title %}{{ project.title }} - Marga Research Institute{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4>Project Details</h4>
                <div>
                    {% if current_user.can_edit_projects() %}
                        <a href="{{ url_for('edit_project', id=project.id) }}" class="btn btn-secondary btn-sm me-2">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                    {% endif %}
                    <a href="{{ url_for('projects') }}" class="btn btn-secondary btn-sm">‚Üê Back to Projects</a>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h2>{{ project.title }}</h2>
                        <p class="text-muted mb-3">{{ project.project_id }}</p>
                        
                        {% if project.description %}
                            <div class="mb-4">
                                <h5>Description</h5>
                                <p>{{ project.description }}</p>
                            </div>
                        {% endif %}
                        
                        <div class="row">
                            {% if project.category %}
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <h5>Category</h5>
                                    <p>{{ project.category }}</p>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% if project.theme %}
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <h5>Theme</h5>
                                    <p>{{ project.theme }}</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if project.team_memberships %}
                            <div class="mb-4">
                                <h5>Team Members</h5>
                                <div class="row">
                                    {% for membership in project.team_memberships %}
                                    <div class="col-md-6 mb-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <strong>{{ membership.user.full_name }}</strong>
                                            <span class="badge bg-info">{{ membership.role }}</span>
                                        </div>
                                        <small class="text-muted">{{ membership.user.username }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6>Project Information</h6>
                                <hr>
                                
                                <div class="mb-2">
                                    <strong>Status:</strong>
                                    <span class="badge {% if project.status == 'Active' %}bg-warning{% elif project.status == 'Completed' %}bg-success{% elif project.status == 'On Hold' %}bg-secondary{% elif project.status == 'Cancelled' %}bg-danger{% else %}bg-light{% endif %}">
                                        {{ project.status }}
                                    </span>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>Principal Investigator:</strong><br>
                                    {{ project.principal_investigator }}
                                </div>
                                
                                {% if project.category %}
                                <div class="mb-2">
                                    <strong>Category:</strong><br>
                                    {{ project.category }}
                                </div>
                                {% endif %}
                                
                                {% if project.theme %}
                                <div class="mb-2">
                                    <strong>Theme:</strong><br>
                                    {{ project.theme }}
                                </div>
                                {% endif %}
                                
                                <div class="mb-2">
                                    <strong>Start Date:</strong><br>
                                    {{ project.start_date.strftime('%B %d, %Y') if project.start_date else 'NA' }}
                                </div>
                                
                                <div class="mb-2">
                                    <strong>End Date:</strong><br>
                                    {{ project.end_date.strftime('%B %d, %Y') if project.end_date else 'NA' }}
                                </div>
                                
                                {% if current_user.can_view_budget() %}
                                    {% if project.budget %}
                                        <div class="mb-2">
                                            <strong>Budget:</strong><br>
                                            {{ project.currency or 'Rs' }} {{ "{:,.2f}".format(project.budget) }}
                                        </div>
                                    {% endif %}
                                {% endif %}
                                
                                {% if project.funding_source %}
                                    <div class="mb-2">
                                        <strong>Funding Source:</strong><br>
                                        {{ project.funding_source }}
                                    </div>
                                {% endif %}
                                
                                <hr>
                                <small class="text-muted">
                                    Created: {{ project.created_at.strftime('%m/%d/%Y') if project.created_at else 'Unknown' }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>Project Documents
                        </h4>
                        <div>
                            <a href="{{ url_for('project_documents', project_id=project.id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-eye me-1"></i>View All Documents
                            </a>
                            {% if current_user.can_edit_projects() %}
                                <a href="{{ url_for('upload_document', project_id=project.id) }}" class="btn btn-primary btn-sm ms-2">
                                    <i class="fas fa-upload me-1"></i>Upload Document
                                </a>
                            {% endif %}
                        </div>
                    </div>

                    {% if project.documents %}
                        <div class="row">
                            {% for document in project.documents[:6] %} <!-- Show first 6 documents -->
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 border">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex align-items-start mb-2">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1">
                                                        <i class="fas fa-file-{{ 'pdf' if document.file_type == 'pdf' else 'word' if document.file_type in ['doc', 'docx'] else 'excel' if document.file_type in ['xls', 'xlsx'] else 'image' if document.file_type in ['jpg', 'jpeg', 'png', 'gif'] else 'alt' }} me-2 text-primary"></i>
                                                        {{ document.original_filename[:30] }}{% if document.original_filename|length > 30 %}...{% endif %}
                                                    </h6>
                                                    {% if document.description %}
                                                        <p class="card-text small text-muted mb-2">{{ document.description[:50] }}{% if document.description|length > 50 %}...{% endif %}</p>
                                                    {% endif %}
                                                </div>
                                            </div>

                                            <div class="mt-auto">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <small class="text-muted">
                                                        <i class="fas fa-user me-1"></i>{{ document.uploader.full_name[:15] }}{% if document.uploader.full_name|length > 15 %}...{% endif %}
                                                    </small>
                                                    <small class="badge bg-{{ 'success' if document.document_type == 'contract' else 'info' if document.document_type == 'report' else 'warning' }}">
                                                        {{ document.get_document_type_display() }}
                                                    </small>
                                                </div>

                                                <a href="{{ url_for('download_document', document_id=document.id) }}"
                                                   class="btn btn-outline-primary btn-sm w-100"
                                                   title="Download {{ document.original_filename }}">
                                                    <i class="fas fa-download me-1"></i>Download
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        {% if project.documents|length > 6 %}
                            <div class="text-center">
                                <a href="{{ url_for('project_documents', project_id=project.id) }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-plus me-1"></i>View {{ project.documents|length - 6 }} More Documents
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4 bg-light rounded">
                            <i class="fas fa-file-alt fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-2">No documents uploaded yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
